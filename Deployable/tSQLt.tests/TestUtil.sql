/*
   Copyright 2011 tSQLt

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
*/
DECLARE @Msg VARCHAR(MAX);SELECT @Msg = 'Compiled at '+CONVERT(VARCHAR,GETDATE(),121);RAISERROR(@Msg,0,1);
GO
IF OBJECT_ID('tSQLt_testutil.Private_Drop_tSQLtTestUtilCLR_objects') IS NOT NULL EXEC('EXEC tSQLt_testutil.Private_Drop_tSQLtTestUtilCLR_objects');
GO
EXEC tSQLt.DropClass tSQLt_testutil;
GO

CREATE SCHEMA tSQLt_testutil;
GO
CREATE PROC tSQLt_testutil.ReThrow @msg NVARCHAR(MAX) = '' AS SET @msg = @msg + '[Msg '+LTRIM(STR(ERROR_NUMBER()))+', Level '+LTRIM(STR(ERROR_SEVERITY()))+', State '+LTRIM(STR(ERROR_STATE()))+ISNULL(', Procedure '+ERROR_PROCEDURE(),'')+', Line '+LTRIM(STR(ERROR_LINE()))+']'+ERROR_MESSAGE();RAISERROR(@msg,16,10);
GO
CREATE PROC tSQLt_testutil.assertFailCalled
    @Command NVARCHAR(MAX),
    @Message VARCHAR(MAX) = NULL
AS
BEGIN
    IF(@Message IS NULL)
    BEGIN
      SET @Message = 'Fail not called when executing <' + @Command + '>';
    END
    DECLARE @CallCount INT;
    DECLARE @Error NVARCHAR(MAX);SET @Error = '';
    BEGIN TRAN;
    DECLARE @TranName CHAR(32); EXEC tSQLt.GetNewTranName @TranName OUT;
    SAVE TRAN @TranName;
      EXEC tSQLt.SpyProcedure 'tSQLt.Fail','RAISERROR(''tSQLt_testutil.assertFailCalled.INTERNAL'',16,10);';
      BEGIN TRY
        EXEC (@Command);
      END TRY
      BEGIN CATCH
        IF(ERROR_MESSAGE() NOT LIKE '%tSQLt_testutil.assertFailCalled.INTERNAL%')
        BEGIN
          ROLLBACK TRAN @TranName;
          COMMIT;
          EXEC tSQLt_testutil.ReThrow;
        END
      END CATCH;
      SELECT @CallCount = COUNT(1) FROM tSQLt.Fail_SpyProcedureLog;
    ROLLBACK TRAN @TranName;
    COMMIT TRAN;

    IF (@CallCount = 0)
    BEGIN
      EXEC tSQLt.Fail @Message,@Error;
    END;
END;
GO

CREATE PROCEDURE tSQLt_testutil.CaptureFailMessage
  @Command NVARCHAR(MAX),
  @FailMessage NVARCHAR(MAX) OUTPUT
AS
BEGIN
  BEGIN TRAN;
  DECLARE @TranName CHAR(32); EXEC tSQLt.GetNewTranName @TranName OUT;
  SAVE TRAN @TranName;
    EXEC tSQLt.SpyProcedure 'tSQLt.Fail','RAISERROR(''tSQLt_testutil.assertFailCalled.INTERNAL'',16,10);';
    BEGIN TRY
      EXEC (@Command);
    END TRY
    BEGIN CATCH
        IF(ERROR_MESSAGE() NOT LIKE '%tSQLt_testutil.assertFailCalled.INTERNAL%')
      BEGIN
        ROLLBACK TRAN @TranName;
        COMMIT;
        EXEC tSQLt_testutil.ReThrow;
      END
    END CATCH;
    SELECT @FailMessage = 
        COALESCE(Message0, '')--should be '!NULL!' but default parameters are not currently supported by SpyProcedure
      + COALESCE(Message1, '')
      + COALESCE(Message2, '')
      + COALESCE(Message3, '')
      + COALESCE(Message4, '')
      + COALESCE(Message5, '')
      + COALESCE(Message6, '')
      + COALESCE(Message7, '')
      + COALESCE(Message8, '')
      + COALESCE(Message9, '') FROM tSQLt.Fail_SpyProcedureLog;
  ROLLBACK TRAN @TranName;
  COMMIT TRAN;
END
GO

CREATE PROC tSQLt_testutil.AssertFailMessageEquals
    @Command NVARCHAR(MAX),
    @ExpectedMessage NVARCHAR(MAX),
    @Message0 VARCHAR(MAX) = NULL,
    @Message1 VARCHAR(MAX) = NULL,
    @Message2 VARCHAR(MAX) = NULL,
    @Message3 VARCHAR(MAX) = NULL,
    @Message4 VARCHAR(MAX) = NULL
AS
BEGIN
    DECLARE @Message VARCHAR(MAX);
    SELECT  @Message = 
        COALESCE(@Message0, '')
      + COALESCE(@Message1, '')
      + COALESCE(@Message2, '')
      + COALESCE(@Message3, '')
      + COALESCE(@Message4, '');

    DECLARE @ActualMessage NVARCHAR(MAX);

    EXEC tSQLt_testutil.CaptureFailMessage 
            @Command ,
            @ActualMessage OUTPUT;

    EXEC tSQLt.AssertEqualsString @ExpectedMessage, @ActualMessage, @Message;
END;
GO

CREATE PROC tSQLt_testutil.AssertFailMessageLike
    @Command NVARCHAR(MAX),
    @ExpectedMessage NVARCHAR(MAX),
    @Message0 VARCHAR(MAX) = NULL,
    @Message1 VARCHAR(MAX) = NULL,
    @Message2 VARCHAR(MAX) = NULL,
    @Message3 VARCHAR(MAX) = NULL,
    @Message4 VARCHAR(MAX) = NULL
AS
BEGIN
    DECLARE @Message VARCHAR(MAX);
    SELECT  @Message = 
        COALESCE(@Message0, '')
      + COALESCE(@Message1, '')
      + COALESCE(@Message2, '')
      + COALESCE(@Message3, '')
      + COALESCE(@Message4, '');

    DECLARE @ActualMessage NVARCHAR(MAX);

    EXEC tSQLt_testutil.CaptureFailMessage 
            @Command ,
            @ActualMessage OUTPUT;

    EXEC tSQLt.AssertLike @ExpectedMessage, @ActualMessage, @Message;
END;
GO

CREATE PROC tSQLt_testutil.RemoveTestClassPropertyFromAllExistingClasses
AS
BEGIN
  DECLARE @TestClassName NVARCHAR(MAX);
  DECLARE @TestProcName NVARCHAR(MAX);

  DECLARE tests CURSOR LOCAL FAST_FORWARD FOR
   SELECT DISTINCT s.name AS testClassName
     FROM sys.extended_properties ep
     JOIN sys.schemas s
       ON ep.major_id = s.schema_id
    WHERE ep.name = N'tSQLt.TestClass';

  OPEN tests;
  
  FETCH NEXT FROM tests INTO @TestClassName;
  WHILE @@FETCH_STATUS = 0
  BEGIN
    EXEC sp_dropextendedproperty @name = 'tSQLt.TestClass',
                                 @level0type = 'SCHEMA',
                                 @level0name = @TestClassName;
    
    FETCH NEXT FROM tests INTO @TestClassName;
  END;
  
  CLOSE tests;
  DEALLOCATE tests;
END;
GO
-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 

CREATE PROCEDURE tSQLt_testutil.CaptureTestResult
  @TestName NVARCHAR(MAX),
  @Result NVARCHAR(MAX) OUTPUT,   
  @Msg NVARCHAR(MAX) OUTPUT    
AS
BEGIN
  DECLARE @Cmd NVARCHAR(MAX);    
  SELECT @Cmd = 'EXEC tSQLt.Private_RunTest '+
                QUOTENAME(
                   QUOTENAME(OBJECT_SCHEMA_NAME(OBJECT_ID(@TestName)))+'.'+
                   QUOTENAME(OBJECT_NAME(OBJECT_ID(@TestName))),'''')+';';
  BEGIN TRAN;
  DECLARE @TranName CHAR(32); EXEC tSQLt.GetNewTranName @TranName OUT;
  SAVE TRAN @TranName;
    TRUNCATE TABLE tSQLt.TestResult;
    EXEC tSQLt.SuppressOutput @Cmd
    SELECT @Result = Result, @Msg = Msg FROM tSQLt.TestResult;
  ROLLBACK TRAN @TranName;
  COMMIT TRAN;
END;
GO
CREATE PROCEDURE tSQLt_testutil.AssertTestFails
  @TestName NVARCHAR(MAX),
  @ExpectedMessage NVARCHAR(MAX) = NULL
AS
BEGIN
    DECLARE @Result NVARCHAR(MAX);
    DECLARE @Msg NVARCHAR(MAX);
    
    EXEC tSQLt_testutil.CaptureTestResult @TestName, @Result OUTPUT, @Msg OUTPUT;
    
    IF(@Result <> 'Failure')
    BEGIN
      EXEC tSQLt.Fail 'Expected test to fail. Instead it resulted in ',@Result,'. The Message is: "',@Msg,'"';
    END
    
    IF(@ExpectedMessage IS NOT NULL)
    BEGIN
      EXEC tSQLt.AssertLike @ExpectedMessage,@Msg,'Incorrect Fail message used:';
    END
END;
GO
CREATE PROCEDURE tSQLt_testutil.AssertTestSucceeds
  @TestName NVARCHAR(MAX)
AS
BEGIN
    DECLARE @Result NVARCHAR(MAX);
    DECLARE @Msg NVARCHAR(MAX);
    
    EXEC tSQLt_testutil.CaptureTestResult @TestName, @Result OUTPUT, @Msg OUTPUT;
    
    IF(@Result <> 'Success')
    BEGIN
      EXEC tSQLt.Fail 'Expected test to succeed. Instead it resulted in ',@Result,'. The Message is: "',@Msg,'"';
    END
END;
GO
CREATE PROCEDURE tSQLt_testutil.AssertTestErrors
  @TestName NVARCHAR(MAX),
  @ExpectedMessage NVARCHAR(MAX) = NULL
AS
BEGIN
    DECLARE @Result NVARCHAR(MAX);
    DECLARE @Msg NVARCHAR(MAX);
    
    EXEC tSQLt_testutil.CaptureTestResult @TestName, @Result OUTPUT, @Msg OUTPUT;
    
    IF(@Result <> 'Error')
    BEGIN
      EXEC tSQLt.Fail 'Expected test to error. Instead it resulted in ',@Result,'. The Message is: "',@Msg,'"';
    END
    
    IF(@ExpectedMessage IS NOT NULL)
    BEGIN
      EXEC tSQLt.AssertLike @ExpectedMessage,@Msg,'Incorrect Error Message:';
    END
END;
GO
-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 
-- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- -- 


GO

CREATE ASSEMBLY [tSQLtTestUtilCLR] AUTHORIZATION [dbo] FROM 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103000636E6610000000000000000E00002210B010B00001A00000006000000000000DE3800000020000000400000000000100020000000020000040000000000000004000000000000000080000000020000566F00000300408500001000001000000000100000100000000000001000000000000000000000008C3800004F000000004000004803000000000000000000000000000000000000006000000C000000543700001C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000E418000000200000001A000000020000000000000000000000000000200000602E72737263000000480300000040000000040000001C0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000002000000000000000000000000000004000004200000000000000000000000000000000C038000000000000480000000200050010240000441300000900000000000000000000000000000050200000800000000000000000000000000000000000000000000000000000000000000000000000C525C0EA71B3E19495C441F8CAAA252BAA88597C8DA78BD339C604CD541DB617265649C9672D3AFEFB27CAB10784DE2C006F87A246C3F3B6699E6BEAF72AABFA20B394E877FC8161BBFDDA9A7252AA1965F1F5FAA093A17B8B3476FA60159C1B291B39B97C2ECB637D2566DC9265B51598ED2D622D49DF848672BBED50DCB970133003004B000000010000111B8D1E0000010A06167201000070A206170F00FE16060000016F1300000AA206187215000070A206190F01FE16060000016F1300000AA2061A7219000070A206281400000A731500000A2A00133003001800000002000011731600000A0A0617026F1700000A0618036F1700000A062A1A731600000A2A0013300200270000000300001102A50200001B0A031200281800000A281900000A8108000001041200281A00000A81060000012A1E02281B00000A2A1E027B020000042A2202037D020000042A1A721D0000702A00133002002C000000040000110375030000022D0B724D000070731E00000A7A0374030000020A027C01000004067B01000004281F00000A2A133002002700000004000011730E0000060A060F00282000000A6F07000006060F00282100000A282200000A7D01000004062A00133002000F00000004000011730E0000060A06176F07000006062A6602036F2300000A280700000602036F2400000A7D010000042A66030228060000066F2500000A03027B010000046F2600000A2A1E02281B00000A2A1E027B040000042A2202037D040000042A1A72970000702A0013300200270000000500001173160000060A060F00282000000A6F10000006060F00282100000A282200000A7D03000004062A00133002000F0000000500001173160000060A06176F10000006062A6602036F2300000A281000000602036F2400000A7D030000042A660302280F0000066F2500000A03027B030000046F2600000A2A1E02281B00000A2A1E027B060000042A2202037D060000042A1A72BF0000702A00133002002C000000060000110375050000022D0B72EB000070731E00000A7A0374050000020A027C05000004067B05000004281F00000A2A133002002700000006000011731F0000060A060F00282000000A6F18000006060F00282100000A282200000A7D05000004062A00133002000F00000006000011731F0000060A06176F18000006062A6602036F2300000A281800000602036F2400000A7D050000042A66030228170000066F2500000A03027B050000046F2600000A2A1E02281B00000A2A1A7E070000042A567321000006282800000A740600000280070000042A1E02282900000A2A42534A4201000100000000000C00000076322E302E35303732370000000005006C000000DC060000237E000048070000E005000023537472696E677300000000280D000034010000235553005C0E00001000000023475549440000006C0E0000D804000023426C6F6200000000000000020000015717A2090900000000FA25330016000001000000270000000600000007000000220000001700000008000000290000001F0000000600000004000000070000000A00000002000000010000000300000000000A000100000000000600A800A1000A00D000BB000A00F500DA0006000601A1000E00270112010A003F01BB000600640151010A008601BB000600E601DC010600F801DC0106007F0260020600B202A0020600C902A0020600E602A00206000503A00206001E03A00206003703A00206005203A00206006D03A00206008603600206009A0360020600A803A0020600C103A0020600EE03DE0306002704140467003B04000006006A044A0406008A044A040A00A804DA000600BD04A1000600E604CB040600F704CB040A002405DA000A004005DA00060047054A0406006205A10006007405A1000E00A80590050E00C60512010000000001000000000001000100010010001F002C00050001000100010010003D002C000500010006000100100051002C00050003000F000100100061002C000500050017000001100073007C001500070020000100A1012B0001000B0258000100A1012B0001000B0258000100A1012B0001000B02580011002F028600D02000000000960049010A00010028210000000096007001130003004C2100000000960078011300050054210000000091008F011C00070087210000000086189B0127000A008F2100000000E609A4012E000A009721000000008108AF0132000A00A02100000000C600BA0137000B00A82100000000E601C3013B000B00E021000000009600CD0140000C001422000000009608D30147000D002F2200000000E601F3014C000D00492200000000E601050252000E0063220000000086189B0127000F006B2200000000E609A4012E000F007322000000008108AF0132000F007C2200000000C600BA01370010008422000000009600CD0164001000B822000000009608D3016B001100D32200000000E601F3014C001100ED2200000000E60105025200120007230000000086189B01270013000F2300000000E609A4012E0013001723000000008108AF0132001300202300000000C600BA0137001400282300000000E601C3013B0014006023000000009600CD01750015009423000000009608D3017C001600AF2300000000E601F3014C001600C92300000000E601050252001700E3230000000086189B0127001800EB230000000096083F028A00180008240000000086189B0127001800F223000000009118BF052E041800000001005302000002005602000001005302000002005602000001005302000002005602000001005902020002005D02020003008C02000001009002000001009602000001009A02000001009C02000001009E02000001009002000001009A02000001009C02000001009E02000001009002000001009602000001009A02000001009C02000001009E020300090003000D00030011000400090004000D000500090005000D000500110059009B01270061009B01940069009B01940071009B01940079009B01940081009B01940089009B01940091009B01940099009B019400A1009B013200A9009B019400B1009B019400B9009B019400C1009B012700C9009B019900D9009B019F00E1009B012700E9009B0127000900BA013700F100C404F70131009B0194000C009B0127000C00F304060314000605210341000E05260314001A052C0309009B01270009019B013C0319019B01270021019B0194002901C30185033100A4012E0031001A0537002901CD018F0349007A052E00490086059403510005023200510005029F0031019B01CE033901D305320429009B0127002000930046012E008B00B8042E001B0051042E00230051042E008300AF042E003B0057042E00730080032E0013003B042E002B0051042E0033003B042E007B00A6042E00430051042E00530051042E005B006F042E006B0099044000930002024100EB0080036000930002026300E30043038100EB0080038300E3009803A300E3009803C000EB008003C100EB008003C300EB008003C3003B01D403E000EB008003E001EB0080030002EB008003E002EB0080030003EB008003FD010E0331038A03C403C90303000100040003000500050006000700000023025B0000002A025F00000023025B0000002A027000000023025B0000002A02810000004B028F0002000600030001000700030002000B00050001001000070002000F000700020013000900020017000B00010018000B0002001C000D00020020000F00FE02180304800000010000000000000001000000A4002C00000002000000000000000000000001009800000000000200000000000000000000000100AF00000000000200000000000000000000000100A1000000000000000000003C4D6F64756C653E007453514C74546573745574696C434C522E646C6C00436C7246756E6374696F6E73007453514C74546573745574696C434C52004461746154797065427974654F7264657265640044617461547970654E6F457175616C00446174615479706557697468457175616C0053657474696E6773007453514C74546573745574696C434C522E50726F70657274696573006D73636F726C69620053797374656D004F626A6563740053797374656D2E446174610053797374656D2E446174612E53716C547970657300494E756C6C61626C65004D6963726F736F66742E53716C5365727665722E536572766572004942696E61727953657269616C697A650049436F6D70617261626C650053797374656D2E436F6E66696775726174696F6E004170706C69636174696F6E53657474696E6773426173650053716C537472696E670041436C725376660053797374656D2E436F6C6C656374696F6E730049456E756D657261626C650041436C7254766600416E456D707479436C725476660053716C496E7433320041436C725476665F526F77002E63746F72005F69006765745F49734E756C6C007365745F49734E756C6C00546F537472696E6700436F6D70617265546F005061727365006765745F4E756C6C0053797374656D2E494F0042696E61727952656164657200526561640042696E617279577269746572005772697465003C49734E756C6C3E6B5F5F4261636B696E674669656C640049734E756C6C004E756C6C0064656661756C74496E7374616E6365006765745F44656661756C740044656661756C7400703100703200726F770069640053797374656D2E52756E74696D652E496E7465726F705365727669636573004F75744174747269627574650076616C0076616C7565006F626A0073007200770053797374656D2E5265666C656374696F6E00417373656D626C795469746C6541747472696275746500417373656D626C794465736372697074696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C79436F6D70616E7941747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7954726164656D61726B41747472696275746500417373656D626C7943756C7475726541747472696275746500436F6D56697369626C65417474726962757465004775696441747472696275746500417373656D626C7956657273696F6E41747472696275746500417373656D626C7946696C6556657273696F6E4174747269627574650053797374656D2E536563757269747900416C6C6F775061727469616C6C795472757374656443616C6C6572734174747269627574650053797374656D2E446961676E6F73746963730044656275676761626C6541747472696275746500446562756767696E674D6F6465730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C6974794174747269627574650053716C46756E6374696F6E41747472696275746500537472696E6700436F6E6361740053797374656D2E436F6C6C656374696F6E732E47656E657269630044696374696F6E617279603200416464004B657956616C7565506169726032006765745F4B6579006F705F496D706C69636974006765745F56616C75650053716C55736572446566696E65645479706541747472696275746500466F726D617400436F6D70696C657247656E65726174656441747472696275746500417267756D656E74457863657074696F6E00496E7433320052656164426F6F6C65616E0052656164496E7433320053797374656D2E436F6465446F6D2E436F6D70696C65720047656E657261746564436F6465417474726962757465002E6363746F720053657474696E6773426173650053796E6368726F6E697A6564000013410043006C0072005300760066003A005B0000037C0000035D00002F3C003C004400610074006100540079007000650042007900740065004F007200640065007200650064003E003E0000494F0062006A0065006300740020006900730020006E006F0074002000610020004400610074006100540079007000650042007900740065004F007200640065007200650064002E0000273C003C00440061007400610054007900700065004E006F0045007100750061006C003E003E00002B3C003C0044006100740061005400790070006500570069007400680045007100750061006C003E003E0000454F0062006A0065006300740020006900730020006E006F00740020006100200044006100740061005400790070006500570069007400680045007100750061006C002E0000000000C8AB59AE65A1984FA5F8CBF54B0AEFB40008B77A5C561934E089080002111911191119080002121D111911190A0003011C101121101119032000010206080320000204200101020320000E042001081C060001120C1119040000120C05200101122505200101122902060203280002040800120C060001121011190400001210040800121006000112141119040000121404080012140306121804000012180408001218042001010E052001011169042001010880A00024000004800000940000000602000000240000525341310004000001000100F7D9A45F2B508C2887A8794B053CE5DEB28743B7C748FF545F1F51218B684454B785054629C1417D1D3542B095D80BA171294948FCF978A502AA03240C024746B563BC29B4D8DCD6956593C0C425446021D699EF6FB4DC2155DE7E393150AD6617EDC01216EA93FCE5F8F7BE9FF605AD2B8344E8CC01BEDB924ED06FD368D1D080AF010003005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E697374696301540209497350726563697365010500010E1D0E0407011D0E80FA010005005455794D6963726F736F66742E53716C5365727665722E5365727665722E446174614163636573734B696E642C2053797374656D2E446174612C2056657273696F6E3D322E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D623737613563353631393334653038390A446174614163636573730000000054020F497344657465726D696E69737469630154020949735072656369736501540E0F5461626C65446566696E6974696F6E18696420494E542C76616C204E56415243484152284D415829540E1146696C6C526F774D6574686F644E616D650B41436C725476665F526F770715127D02081119072002011300130109070115127D02081119081511808102081119042000130005000111210804200013010A07011511808102081119062001011180893C010002000000030054080B4D61784279746553697A650500000054020D497346697865644C656E6774680154020D4973427974654F7264657265640104010000000420010808040701120C040001080E032000082B010002000000020054080B4D61784279746553697A650500000054020D497346697865644C656E6774680104070112100407011214052002010E0E5901004B4D6963726F736F66742E56697375616C53747564696F2E456469746F72732E53657474696E677344657369676E65722E53657474696E677353696E676C6546696C6547656E657261746F720831322E302E302E3000000300000108000112809D12809D150100107453514C74546573745574696C434C52000005010000000017010012436F7079726967687420C2A920203230313200002901002438326336353236622D646535632D346233322D613939622D32346437356163623966346600000C010007312E302E302E3000000801000200000000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F77730100000000000636E66100000000020000001C0100007037000070190000525344530BF3A0EA0C238F4EBA41AB097CF2106901000000633A5C446174615C6769745C7453514C745C7453514C745C7453514C74434C525C7453514C74546573745574696C434C525C6F626A5C437275697365436F6E74726F6C5C7453514C74546573745574696C434C522E70646200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000B43800000000000000000000CE380000002000000000000000000000000000000000000000000000C0380000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF2500200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000F00200000000000000000000F00234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00450020000010053007400720069006E006700460069006C00650049006E0066006F0000002C02000001003000300030003000300034006200300000004C0011000100460069006C0065004400650073006300720069007000740069006F006E00000000007400530051004C00740054006500730074005500740069006C0043004C00520000000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E00300000004C001500010049006E007400650072006E0061006C004E0061006D00650000007400530051004C00740054006500730074005500740069006C0043004C0052002E0064006C006C00000000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003100320000005400150001004F0072006900670069006E0061006C00460069006C0065006E0061006D00650000007400530051004C00740054006500730074005500740069006C0043004C0052002E0064006C006C0000000000440011000100500072006F0064007500630074004E0061006D006500000000007400530051004C00740054006500730074005500740069006C0043004C00520000000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E003000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000E03800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 WITH PERMISSION_SET = SAFE;


GO

CREATE FUNCTION tSQLt_testutil.GetUnsignedEmptyBytes()
RETURNS TABLE
AS
RETURN
  SELECT 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C0103000736E6610000000000000000E00002210B010B000006000000060000000000002E250000002000000040000000000010002000000002000004000000000000000400000000000000008000000002000000000000030040850000100000100000000010000010000000000000100000000000000000000000E02400004B000000004000002803000000000000000000000000000000000000006000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E7465787400000034050000002000000006000000020000000000000000000000000000200000602E7273726300000028030000004000000004000000080000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000000C00000000000000000000000000004000004200000000000000000000000000000000102500000000000048000000020005005020000090040000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000042534A4201000100000000000C00000076322E302E35303732370000000005006C00000068010000237E0000D4010000F401000023537472696E677300000000C80300000800000023555300D0030000100000002347554944000000E0030000B000000023426C6F620000000000000002000001071400000900000000FA253300160000010000000E000000010000000E0000000C000000010000000100000000000A000100000000000600370025000600540025000600710025000600900025000600A90025000600C20025000600DD0025000600F800250006003001110106004401110106005201250006006B0125000600A80188010600C8018801000000000100000000000100010009004E000A0011004E000A0019004E000A0021004E000A0029004E000A0031004E000A0039004E000A0041004E000A0049004E000F0051004E000A0059004E000A0061004E000A0069004E00140071004E0019002E000B001D002E00130030002E001B0030002E00230030002E002B001D002E00330036002E003B0030002E004B0030002E0053004E002E00630078002E006B0085002E0073008E00048000000100000000000000000000000000E601000002000000000000000000000001001C00000000000000003C4D6F64756C653E00556E7369676E6564456D7074792E646C6C006D73636F726C69620053797374656D2E5265666C656374696F6E00417373656D626C795469746C65417474726962757465002E63746F7200417373656D626C794465736372697074696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E41747472696275746500417373656D626C79436F6D70616E7941747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C7954726164656D61726B41747472696275746500417373656D626C7943756C747572654174747269627574650053797374656D2E52756E74696D652E496E7465726F70536572766963657300436F6D56697369626C65417474726962757465004775696441747472696275746500417373656D626C7956657273696F6E41747472696275746500417373656D626C7946696C6556657273696F6E4174747269627574650053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300436F6D70696C6174696F6E52656C61786174696F6E734174747269627574650052756E74696D65436F6D7061746962696C69747941747472696275746500556E7369676E6564456D7074790000032000000000003F49AC7F929A7A49B9D9E6A2398FC7590008B77A5C561934E089042001010E04200101020420010108032000011201000D556E7369676E6564456D707479000005010000000017010012436F7079726967687420C2A920203230313500002901002432313565313935372D353138392D343230392D613362302D36623235613435383837363200000C010007312E302E302E3000000801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010000000825000000000000000000001E250000002000000000000000000000000000000000000000000000102500000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000D00200000000000000000000D00234000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000000000000000100000000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00430020000010053007400720069006E006700460069006C00650049006E0066006F0000000C020000010030003000300030003000340062003000000044000E000100460069006C0065004400650073006300720069007000740069006F006E000000000055006E007300690067006E006500640045006D007000740079000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E003000000044001200010049006E007400650072006E0061006C004E0061006D006500000055006E007300690067006E006500640045006D007000740079002E0064006C006C0000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003100350000004C00120001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000055006E007300690067006E006500640045006D007000740079002E0064006C006C0000003C000E000100500072006F0064007500630074004E0061006D0065000000000055006E007300690067006E006500640045006D007000740079000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003000000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E0030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000C000000303500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 AS UnsignedEmptyBytes;



GO

GO
CREATE PROCEDURE tSQLt_testutil.Private_Drop_tSQLtTestUtilCLR_objects
AS
BEGIN
  IF TYPE_ID('tSQLt_testutil.DataTypeNoEqual') IS NOT NULL DROP TYPE tSQLt_testutil.DataTypeNoEqual;
  IF TYPE_ID('tSQLt_testutil.DataTypeWithEqual') IS NOT NULL DROP TYPE tSQLt_testutil.DataTypeWithEqual;
  IF TYPE_ID('tSQLt_testutil.DataTypeByteOrdered') IS NOT NULL DROP TYPE tSQLt_testutil.DataTypeByteOrdered;
  IF OBJECT_ID('tSQLt_testutil.AClrSvf') IS NOT NULL DROP FUNCTION tSQLt_testutil.AClrSvf;
  IF OBJECT_ID('tSQLt_testutil.AClrTvf') IS NOT NULL DROP FUNCTION tSQLt_testutil.AClrTvf;
  IF OBJECT_ID('tSQLt_testutil.AnEmptyClrTvf') IS NOT NULL DROP FUNCTION tSQLt_testutil.AnEmptyClrTvf;
  IF EXISTS (SELECT 1 FROM sys.assemblies WHERE name = 'tSQLtTestUtilCLR')DROP ASSEMBLY tSQLtTestUtilCLR;
END
GO
CREATE TYPE tSQLt_testutil.DataTypeNoEqual EXTERNAL NAME tSQLtTestUtilCLR.[tSQLtTestUtilCLR.DataTypeNoEqual];
CREATE TYPE tSQLt_testutil.DataTypeWithEqual EXTERNAL NAME tSQLtTestUtilCLR.[tSQLtTestUtilCLR.DataTypeWithEqual];
CREATE TYPE tSQLt_testutil.DataTypeByteOrdered EXTERNAL NAME tSQLtTestUtilCLR.[tSQLtTestUtilCLR.DataTypeByteOrdered];
GO
CREATE FUNCTION tSQLt_testutil.AClrSvf(@p1 NVARCHAR(MAX), @p2 NVARCHAR(MAX))RETURNS NVARCHAR(MAX) 
       AS EXTERNAL NAME tSQLtTestUtilCLR.[tSQLtTestUtilCLR.ClrFunctions].AClrSvf;
GO
CREATE FUNCTION tSQLt_testutil.AClrTvf(@p1 NVARCHAR(MAX), @p2 NVARCHAR(MAX))RETURNS TABLE(id INT, val NVARCHAR(MAX))
       AS EXTERNAL NAME tSQLtTestUtilCLR.[tSQLtTestUtilCLR.ClrFunctions].AClrTvf;
GO
CREATE FUNCTION tSQLt_testutil.AnEmptyClrTvf(@p1 NVARCHAR(MAX), @p2 NVARCHAR(MAX))RETURNS TABLE(id INT, val NVARCHAR(MAX))
       AS EXTERNAL NAME tSQLtTestUtilCLR.[tSQLtTestUtilCLR.ClrFunctions].AnEmptyClrTvf;
GO


GO

GO
EXEC tSQLt.NewTestClass 'tSQLt_testutil_test';
GO
CREATE PROCEDURE tSQLt_testutil_test.[test DataTypeNoEqual can be serialized]
AS
BEGIN
  DECLARE @inst1 tSQLt_testutil.DataTypeNoEqual;
  DECLARE @inst1bin BINARY(5);
  DECLARE @inst2 tSQLt_testutil.DataTypeNoEqual;
  DECLARE @inst2bin BINARY(5);

  SET @inst1 = '1';
  SET @inst1bin = CAST(@inst1 AS BINARY(5));
  EXEC tSQLt.AssertEquals 0x0001000000, @inst1bin;

  SET @inst2 = CAST(@inst1bin AS tSQLt_testutil.DataTypeNoEqual);
  SET @inst2bin = CAST(@inst2 AS BINARY(5));
  EXEC tSQLt.AssertEquals 0x0001000000, @inst2bin;
  
END
GO
CREATE PROCEDURE tSQLt_testutil_test.[test DataTypeNoEqual has constant ToString()]
AS
BEGIN
  DECLARE @inst1 tSQLt_testutil.DataTypeNoEqual;
  DECLARE @inst1str NVARCHAR(MAX);
  DECLARE @inst2 tSQLt_testutil.DataTypeNoEqual;
  DECLARE @inst2str NVARCHAR(MAX);

  SET @inst1 = '1';
  SET @inst2 = '2';
  
  SET @inst1str = @inst1.ToString();
  SET @inst2str = @inst2.ToString();
  
  EXEC tSQLt.AssertEqualsString @inst1str,@inst2str;
END
GO
CREATE PROCEDURE tSQLt_testutil_test.[test DataTypeNoEqual cannot compare]
AS
BEGIN
  DECLARE @Message NVARCHAR(MAX);
  SET @Message = '<No Error>';
  
  BEGIN TRY
    EXEC('IF(CAST( ''1'' AS tSQLt_testutil.DataTypeNoEqual) = CAST( ''2'' AS tSQLt_testutil.DataTypeNoEqual)) PRINT 1;')
  END TRY  
  BEGIN CATCH
  SELECT @Message = ERROR_MESSAGE()
  END CATCH
  
  EXEC tSQLt.AssertEqualsString 'Invalid operator for data type. Operator equals equal to, type equals DataTypeNoEqual.',@Message;
  
END
GO
CREATE PROCEDURE tSQLt_testutil_test.[test DataTypeNoEqual cannot GROUP BY]
AS
BEGIN
  DECLARE @Message NVARCHAR(MAX);
  SET @Message = '<No Error>';
  
  CREATE TABLE tSQLt_testutil_test.tmp1(
    id INT IDENTITY(1,1) PRIMARY KEY CLUSTERED,
    dtne tSQLt_testutil.DataTypeNoEqual NULL
  );
  
  INSERT INTO tSQLt_testutil_test.tmp1(dtne)VALUES('1');
  INSERT INTO tSQLt_testutil_test.tmp1(dtne)VALUES('1');

  BEGIN TRY
    EXEC('SELECT dtne,COUNT(1) Cnt FROM tSQLt_testutil_test.tmp1 GROUP BY dtne;');
  END TRY  
  BEGIN CATCH
  SELECT @Message = ERROR_MESSAGE()
  END CATCH
  
  EXEC tSQLt.AssertEqualsString 'The type "DataTypeNoEqual" is not comparable. It cannot be used in the GROUP BY clause.',@Message;
  
END
GO
------------------------------------------------------------------------------------------------------------
GO
CREATE PROCEDURE tSQLt_testutil_test.[test DataTypeWithEqual can be serialized]
AS
BEGIN
  DECLARE @inst1 tSQLt_testutil.DataTypeWithEqual;
  DECLARE @inst1bin BINARY(5);
  DECLARE @inst2 tSQLt_testutil.DataTypeWithEqual;
  DECLARE @inst2bin BINARY(5);

  SET @inst1 = '1';
  SET @inst1bin = CAST(@inst1 AS BINARY(5));
  EXEC tSQLt.AssertEquals 0x0001000000, @inst1bin;

  SET @inst2 = CAST(@inst1bin AS tSQLt_testutil.DataTypeWithEqual);
  SET @inst2bin = CAST(@inst2 AS BINARY(5));
  EXEC tSQLt.AssertEquals 0x0001000000, @inst2bin;
  
END
GO
CREATE PROCEDURE tSQLt_testutil_test.[test DataTypeWithEqual has constant ToString()]
AS
BEGIN
  DECLARE @inst1 tSQLt_testutil.DataTypeWithEqual;
  DECLARE @inst1str NVARCHAR(MAX);
  DECLARE @inst2 tSQLt_testutil.DataTypeWithEqual;
  DECLARE @inst2str NVARCHAR(MAX);

  SET @inst1 = '1';
  SET @inst2 = '2';
  
  SET @inst1str = @inst1.ToString();
  SET @inst2str = @inst2.ToString();
  
  EXEC tSQLt.AssertEqualsString @inst1str,@inst2str;
END
GO
CREATE PROCEDURE tSQLt_testutil_test.[test DataTypeWithEqual has CompareTo (but we can't use it...)]
AS
BEGIN
  DECLARE @Message NVARCHAR(MAX);
  SET @Message = '<No Error>';
  DECLARE @inst1 tSQLt_testutil.DataTypeWithEqual;

  SET @inst1 = '1';
  
  BEGIN TRY
    PRINT @inst1.CompareTo(CAST(@inst1 AS BINARY(5)));
  END TRY  
  BEGIN CATCH
    SELECT @Message = ERROR_MESSAGE()
  END CATCH
  
  EXEC tSQLt.AssertLike '%Object is not a DataTypeWithEqual.%',@Message;

END
GO
CREATE PROCEDURE tSQLt_testutil_test.[test DataTypeWithEqual cannot compare]
AS
BEGIN
  DECLARE @Message NVARCHAR(MAX);
  SET @Message = '<No Error>';
  
  BEGIN TRY
    EXEC('IF(CAST( ''1'' AS tSQLt_testutil.DataTypeWithEqual) = CAST( ''2'' AS tSQLt_testutil.DataTypeWithEqual)) PRINT 1;')
  END TRY  
  BEGIN CATCH
  SELECT @Message = ERROR_MESSAGE()
  END CATCH
  
  EXEC tSQLt.AssertEqualsString 'Invalid operator for data type. Operator equals equal to, type equals DataTypeWithEqual.',@Message;
  
END
GO
CREATE PROCEDURE tSQLt_testutil_test.[test DataTypeWithEqual cannot GROUP BY]
AS
BEGIN
  DECLARE @Message NVARCHAR(MAX);
  SET @Message = '<No Error>';
  
  CREATE TABLE tSQLt_testutil_test.tmp1(
    id INT IDENTITY(1,1) PRIMARY KEY CLUSTERED,
    dtne tSQLt_testutil.DataTypeWithEqual NULL
  );
  
  INSERT INTO tSQLt_testutil_test.tmp1(dtne)VALUES('1');
  INSERT INTO tSQLt_testutil_test.tmp1(dtne)VALUES('1');

  BEGIN TRY
    EXEC('SELECT dtne,COUNT(1) Cnt FROM tSQLt_testutil_test.tmp1 GROUP BY dtne;');
  END TRY  
  BEGIN CATCH
  SELECT @Message = ERROR_MESSAGE()
  END CATCH
  
  EXEC tSQLt.AssertEqualsString 'The type "DataTypeWithEqual" is not comparable. It cannot be used in the GROUP BY clause.',@Message;
  
END
GO
------------------------------------------------------------------------------------------------------------
GO
CREATE PROCEDURE tSQLt_testutil_test.[test DataTypeByteOrdered can be serialized]
AS
BEGIN
  DECLARE @inst1 tSQLt_testutil.DataTypeByteOrdered;
  DECLARE @inst1bin BINARY(5);
  DECLARE @inst2 tSQLt_testutil.DataTypeByteOrdered;
  DECLARE @inst2bin BINARY(5);

  SET @inst1 = '1';
  SET @inst1bin = CAST(@inst1 AS BINARY(5));
  EXEC tSQLt.AssertEquals 0x0001000000, @inst1bin;

  SET @inst2 = CAST(@inst1bin AS tSQLt_testutil.DataTypeByteOrdered);
  SET @inst2bin = CAST(@inst2 AS BINARY(5));
  EXEC tSQLt.AssertEquals 0x0001000000, @inst2bin;
  
END
GO
CREATE PROCEDURE tSQLt_testutil_test.[test DataTypeByteOrdered has constant ToString()]
AS
BEGIN
  DECLARE @inst1 tSQLt_testutil.DataTypeByteOrdered;
  DECLARE @inst1str NVARCHAR(MAX);
  DECLARE @inst2 tSQLt_testutil.DataTypeByteOrdered;
  DECLARE @inst2str NVARCHAR(MAX);

  SET @inst1 = '1';
  SET @inst2 = '2';
  
  SET @inst1str = @inst1.ToString();
  SET @inst2str = @inst2.ToString();
  
  EXEC tSQLt.AssertEqualsString @inst1str,@inst2str;
END
GO
CREATE PROCEDURE tSQLt_testutil_test.[test DataTypeByteOrdered has CompareTo (but we can't use it...)]
AS
BEGIN
  DECLARE @Message NVARCHAR(MAX);
  SET @Message = '<No Error>';
  DECLARE @inst1 tSQLt_testutil.DataTypeByteOrdered;

  SET @inst1 = '1';
  
  BEGIN TRY
    PRINT @inst1.CompareTo(CAST(@inst1 AS BINARY(5)));
  END TRY  
  BEGIN CATCH
    SELECT @Message = ERROR_MESSAGE()
  END CATCH
  
  EXEC tSQLt.AssertLike '%Object is not a DataTypeByteOrdered.%',@Message;

END
GO
CREATE PROCEDURE tSQLt_testutil_test.[test DataTypeByteOrdered can compare]
AS
BEGIN
  DECLARE @Message NVARCHAR(MAX);
  SET @Message = '<No Error>';
  
  IF(CAST( '1' AS tSQLt_testutil.DataTypeByteOrdered) = CAST( '2' AS tSQLt_testutil.DataTypeByteOrdered))
  BEGIN
    EXEC tSQLt.Fail '1 and 2 should not be equal...';
  END  
  
END
GO
CREATE PROCEDURE tSQLt_testutil_test.[test DataTypeByteOrdered can GROUP BY]
AS
BEGIN
  DECLARE @Message NVARCHAR(MAX);
  SET @Message = '<No Error>';
  
  CREATE TABLE tSQLt_testutil_test.tmp1(
    id INT IDENTITY(1,1) PRIMARY KEY CLUSTERED,
    dtne tSQLt_testutil.DataTypeByteOrdered NULL
  );
  
  INSERT INTO tSQLt_testutil_test.tmp1(dtne)VALUES('1');
  INSERT INTO tSQLt_testutil_test.tmp1(dtne)VALUES('1');
  INSERT INTO tSQLt_testutil_test.tmp1(dtne)VALUES('2');
  INSERT INTO tSQLt_testutil_test.tmp1(dtne)VALUES('2');
  INSERT INTO tSQLt_testutil_test.tmp1(dtne)VALUES('2');

  SELECT CAST(dtne AS BINARY(5)) dtne,COUNT(1) cnt 
  INTO #actual
  FROM tSQLt_testutil_test.tmp1 GROUP BY dtne;
  
  SELECT TOP(0)* INTO #expected FROM #actual;
  INSERT INTO #expected(dtne, cnt)
  SELECT 0x0001000000, 2
  UNION ALL
  SELECT 0x0002000000, 3;
  
  EXEC tSQLt.AssertEqualsTable '#expected','#actual';
END
GO



GO

