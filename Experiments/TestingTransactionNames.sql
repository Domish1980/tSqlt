IF(XACT_STATE()<>0)ROLLBACK
GO
DROP TABLE IF EXISTS #Actual
GO
DECLARE @TranName NVARCHAR(32) = NULL;
SELECT 1,@@TRANCOUNT
SELECT 1 X,@@TRANCOUNT TC INTO #Actual
BEGIN TRAN;
SELECT 2,@@TRANCOUNT
INSERT INTO #Actual VALUES(2,@@TRANCOUNT);
SAVE TRAN @TranName;
SELECT 3,@@TRANCOUNT
SELECT * FROM sys.dm_tran_current_transaction AS DTCT JOIN sys.dm_tran_session_transactions 
AS DTAT ON DTAT.transaction_id = DTCT.transaction_id
INSERT INTO #Actual VALUES(3,@@TRANCOUNT);
SELECT * FROM #Actual AS A
ROLLBACK TRAN @TranName;
SELECT 4,@@TRANCOUNT
INSERT INTO #Actual VALUES(4,@@TRANCOUNT);
COMMIT;
SELECT * FROM #Actual AS A
